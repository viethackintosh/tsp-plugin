import{Notice as t,Modal as e,fchRequest as a,createFormItem as n}from"./index.min.js";import{Editor as r}from"./helpers/edit.min.js";import{USER_API as o,ORDER_API as i,PRODUCT_API as s}from"./helpers/const.min.js";let Master=function(){let t=this;t.frmMaster,t.data,t.title,t.storageName="",t.restAPI="",t.init=async({id:e,templateName:n,restAPI:r})=>{if(t.data=JSON.parse(localStorage.getItem(t.storageName))??{},t.restAPI=r,t.frmMaster=document.querySelector(`#${e}`),t.frmMaster){let o=t.data?.forms,i=o?o.find(t=>!0===t.status):await a({ftchURI:`${t.restAPI}/${n}`}),s=t.modifiedContent({template:i.template,className:"quotation-info"});o||(i.status=!0,i.modifies=s.elements,i.template=s.template,t.data={...t.data,forms:[i]});let l=s.templateDOM;o&&o.find(t=>!0===t.status).modifies.filter(({changed:t})=>!0===t).forEach(({id:t,content:e})=>{l.querySelector(`#${t}`).innerHTML=e}),l=t.onMainPage({layout:l,data:t.data}),t.frmMaster.append(t.buildForm({layout:l})),window.addEventListener("keydown",e=>t.ctrlSToSave({event:e,quotation:t.data})),t.setAtutoSave(3e5)}else t.otherPage();return t},t.setAtutoSave=e=>setInterval(()=>{!0===t.data.saved&&t.data.saved||t.saveProducts({message:"Tự động lưu dữ liệu xuống localStorage!"})},e),t.onMainPage=({layout:e,data:a})=>(e=t.pushSrcImage({options:a?.options,layout:e}),e=t.pushUserTocurrentLayout({user:a?.user,layout:e}),e=t.pushProduct({products:a?.products,layout:e})),t.pushProduct=({products:e,layout:a})=>{if(!e)return a;let r=Array.from(a.querySelectorAll(".table__header .table__column")).map(t=>t.classList[1]),o=e.map((e,a)=>{let o="table__row",i=[];"onprint"!=e.status&&(o="noprint",i=[t.createOverlay({target:e.parentID,message:"Sản phẩm n\xe0y sẽ kh\xf4ng được in, bạn muốn",restore:t.restoreProduct}),]);let s=r.map(n=>t[`pushField${n}`]({product:e,index:a}));return n({tag:"div",className:o,id:`product_${e.parentID}`,children:[n({tag:"div",className:"childcontainer",children:s}),...i,]})});return a.querySelector(".products__list").append(...o),a},t.pushFieldindex=({product:t,index:e})=>({tag:"div",className:"table__column index",innerHTML:`<span>${e+1}</span>`}),t.pushFieldspecs=({product:e,index:a})=>{let{parentID:r,productName:o,attributes:i,orderId:s}=e;return n({tag:"div",className:"table__column specs",children:[t.productName({path:t.createPathUpdate({path:".products{0}",logic:s?[{orderId:s,parentID:r}]:[{parentID:r}]}),field:"productName",value:o}),...i?t.createAttribute({parentID:r,orderId:s,attributes:i}):[]]})},t.pushFieldunit=({product:e,index:a})=>{let{unit:r,parentID:o,orderId:i}=e;return n({tag:"div",className:"table__column unit",children:[t.createUnit({unit:r,parentID:o,orderId:i,edit:!0,methods:{onfocusout:e=>t.updateDataLineEdited({target:e.target,quotation:t.data}),onkeydown:e=>t.nomalEnterToUpdate({event:e,quotation:t.data})}})]})},t.pushFieldquantity=({product:e,index:a})=>{let{orderId:r,parentID:o,prices:i}=e;return n({tag:"div",className:"table__column quantity",children:t.createChildProduct({orderId:r,parentID:o,prices:i,field:"quantity",edit:!0})})},t.pushFieldprice=({product:e,index:a})=>{let{orderId:r,parentID:o,prices:i}=e;return n({tag:"div",className:"table__column price",children:t.createChildProduct({orderId:r,parentID:o,prices:i,field:"price",edit:!0})})},t.pushFieldtotal=({product:e,index:a})=>{let{orderId:r,parentID:o,prices:i}=e;return n({tag:"div",className:"table__column total",children:t.createChildProduct({orderId:r,parentID:o,prices:i,field:"total",edit:!1})})},t.pushFieldnote=({product:e,index:a})=>{let{orderId:r,parentID:o,prices:i}=e;return n({tag:"div",className:"table__column note",children:t.createChildProduct({orderId:r,parentID:o,prices:i,field:"note",edit:!0})})},t.pushFieldenableprint=({product:e,index:a})=>{let{parentID:r}=e;return n({tag:"div",className:"table__column enableprint",children:t.createEnablePrint({ID:r,forProduct:!0,onclickMethod:t.noprintProduct})})},t.modifiedContent=({template:e,className:a})=>new r().init({template:e,className:a,config:{processEvent:{onfocusout:e=>t.updateContentEditedElement({event:e,quotation:t.data})}}}),t.otherPage=()=>{},t.buildForm=({layout:e})=>n({tag:"div",className:"sheet__content quotation",innerHTML:`<h2 class="sheet__title">${t.title}</h2>`,children:[n({tag:"div",className:"quotation__content",children:[t.accordionQuotation({layout:e}),]}),]}),t.accordionQuotation=({layout:e})=>n({tag:"div",className:"accordion",id:"accordion",children:[n({tag:"div",className:"accordion__item noprint",id:"template",children:[{tag:"h4",className:"accordion__heading",innerHTML:`<span class='accordion__title accordion__control'>Lựa chọn mẫu b\xe1o gi\xe1</span>
                                        `,target:"template"},n({tag:"div",className:"accordion__content",children:[t.setChoiceOptions()]}),]}),n({tag:"div",className:"accordion__item active",id:"preview",children:[{tag:"h4",className:"accordion__heading",innerHTML:`<span class='accordion__title accordion__control'>Xem trước</span>
                                        
                                        `,target:"preview"},{tag:"div",className:"accordion__content",style:"max-height:297mm",append:[t.saveMode(),e.children[0],]}]}),]}),t.setChoiceOptions=()=>n({tag:"div",className:"column__inside customer",children:[n({tag:"div",className:"form__groups settemplate",children:[n({tag:"div",className:"form__items choice__template",meta:"options",children:[{tag:"label",className:"form__item form__label",innerHTML:"Chọn mẫu b\xe1o gi\xe1"},{tag:"select",className:"form__field form__item regular-text wd-100",name:"template"},]}),n({tag:"div",className:"form__items group choice__stamp",children:[n({tag:"div",className:"form__item controllers",meta:"options",children:[{tag:"label",className:"form__item form__label",innerHTML:"Dấu c\xf4ng ty"},{tag:"input",type:"text",className:"form__field form__item regular-text wd-100",name:"stampLink",value:t.data?.options?.stampLink??"/wp-content/uploads/2019/08/moccoty.png"},{tag:"button",className:"form__item form__button",innerHTML:"Chọn dấu c\xf4ng ty",style:"cursor: pointer",onclick:e=>t.openWordpressMediaBox({event:e})},]}),{tag:"img",className:"company__stamp",name:"stamp",src:t.data?.options?.stampLink??"/wp-content/uploads/2019/08/moccoty.png"},]}),n({tag:"div",className:"form__items stamp__onoff",children:[{tag:"label",className:"form__item form__label",innerHTML:"Hiện dấu c\xf4ng ty"},n({tag:"div",className:"wrapper",meta:"options",children:[{tag:"input",type:"checkbox",name:"stampEnable",className:"form__field checkbox",checked:t.data?.options?.stampEnable??!0,target:"stampLink",onchange:e=>t.updateCheckbox({event:e,data:t.data})}]}),]}),n({tag:"div",className:"form__items group signature",children:[n({tag:"div",className:"form__item controllers",meta:"options",children:[{tag:"label",className:"form__item form__label",innerHTML:"Chữ k\xfd"},{tag:"input",type:"text",className:"form__field form__item regular-text wd-100",name:"signatureLink",value:t.data?.options?.signatureLink??"/wp-content/uploads/2019/08/signature.png"},{tag:"button",className:"form__item form__button",innerHTML:"chọn chữ k\xfd",style:"cursor: pointer",onclick:e=>t.openWordpressMediaBox({event:e})},]}),{tag:"img",className:"company__stamp",src:t.data?.options?.signatureLink??"/wp-content/uploads/2019/08/signature.png"},]}),n({tag:"div",className:"form__items stamp__onoff",children:[{tag:"label",className:"form__item form__label",innerHTML:"Hiện chữ k\xfd"},n({tag:"div",className:"wrapper",meta:"options",children:[{tag:"input",type:"checkbox",name:"signatureEnable",className:"form__field checkbox",checked:t.data?.options?.signatureEnable??!0,target:"signatureLink",onchange:e=>t.updateCheckbox({event:e,data:t.data})}]}),]}),]}),]}),t.saveMode=()=>n({tag:"div",className:"buttons__modifies noprint",style:"padding: 5px 10px; font-size: 13px; font-style: italic; text-align: right",innerHTML:"Ctrl+S lưu dữ liệu; Ctrl+R tải lại biểu mẫu cơ bản; Ctrl+E tải lại biểu mẫu từ m\xe1y chủ; Ctrl+P in biểu mẫu."}),t.openWordpressMediaBox=({event:e})=>{e.preventDefault();let a=wp.media({title:"Upload Email",multiple:!1}).open().on("select",()=>{let n=a.state().get("selection").first().toJSON().url;t.updateController({event:e,value:n,data:t.data})})},t.saveProducts=({message:e})=>{t.data.saved=!0,localStorage.setItem(t.storageName,JSON.stringify(t.data)),masterNotice.open({message:e,icon:!0,style:"info",timer:1500})},t.refreshTemplateOnServer=async({restAPI:e,form:n})=>{try{let r=await a({ftchURI:`${e}/${n.name}`});n.template=r.template;let o=t.modifiedContent({template:n.template,className:"quotation-info"});n.template=o.template,n.modifies=o.elements,t.saveProducts({message:"Đ\xe3 tải biểu mẫu từ m\xe1y chủ! Vui l\xf2ng đợi tải lại trang!"}),window.location.reload()}catch{}},t.refreshTemplate=({form:e})=>{e.modifies.map(t=>t.changed=!1),t.saveProducts({message:"Đ\xe3 tải lại biểu mẫu cơ bản! Vui l\xf2ng đợi tải lại trang! "}),window.location.reload()},t.setAddQuotaionButtons=()=>{},t.updateController=({event:t,value:e,data:a})=>{let n=t.target,r=n.parentElement,o=r.meta,i=n.previousElementSibling,s=r.nextSibling;i.value=e,s.src=e,a[o]?a[o][i.name]=e:a[o]={[i.name]:e}},t.updateCheckbox=({event:t,data:e})=>{let a=t.target,n=a.parentElement.meta,r=a.checked,o=document.querySelector(`img.${a.target}`);!1===r?o.classList.add("noprint","nodisplay"):o.classList.remove("noprint","nodisplay"),e[n]?e[n][a.name]=r:e[n]={[a.name]:r}},t.getProduct=({ID:t})=>a({ftchURI:`${s}/${t}`,data:{method:"GET"}}).then(t=>(t.product.prices.map(t=>t.total=t.quantity*t.price),t.product.status="onprint",t.product)),t.getUser=({user:t})=>a({ftchURI:`${o}/${t}`,data:{method:"GET"}}),t.getOrder=({orderId:t})=>a({ftchURI:`${i}/${t}`,data:{method:"GET"}}),t.pushSrcImage=({options:t,layout:e})=>{if(!t)return e;let a={signature:"/wp-content/uploads/2019/08/signature.png",stamp:"/wp-content/uploads/2019/08/moccoty.png"};return["signature","stamp"].forEach(n=>{let r=e.querySelector(`.${n}Link`);r.src=t[`${n}Link`]??a[n],t[`${n}Enable`]&&!1!==t[`${n}Enable`]?r.classList.remove("noprint","nodisplay"):r.classList.add("noprint","nodisplay")}),e},t.pushUserTocurrentLayout=({user:e,layout:a})=>{if(!e)return a;let{user_id:n,nickname:r,...o}=e;return Object.entries(o).forEach(([e,n])=>{let r=a.querySelector(`.${e}`);r&&Object.assign(r,{data:{path:".user",field:e,value:n},contentEditable:!0,innerHTML:n,onfocusout:e=>t.updateDataLineEdited({target:e.target,quotation:t.data}),onkeydown:e=>t.nomalEnterToUpdate({event:e,quotation:t.data})})}),a},t.updateDataLineEdited=({target:e,quotation:a,beforeUpdate:n,afterUpdate:r})=>{let o=e.textContent,i=n?n({target:e}):o;e.data.value=i;let s=t.superSearchField({target:a,path:e.data.path});Array.isArray(s)&&(s=s[0]),s[e.data.field]=i,t.data.saved=!1,r&&r.forEach(t=>t({target:e,quotation:a}))},t.superSearchField=({target:e,path:a})=>{if(!e)return;if(!a)return e;let n=a.split(".")[1];if(!n)return e;let r=a.replace(`.${n}`,"");if(-1===n.indexOf("|"))return t.superSearchField({target:e[n],path:r});{let[o,i]=n.split("|"),s=(e=e.length?e:[e]).filter(t=>t[o]==i);return 1===s.length&&(s=s[0]),t.superSearchField({target:s,path:r})}},t.endUserEditting=({target:t,quotation:e})=>{let{table:a,field:n}=t.data,r=t.textContent;e[a][n]=r},t.createOverlay=({target:e,message:a,restore:r})=>n({tag:"span",className:"overlay",innerHTML:`<p class="mask">${a}</p>`,children:[{tag:"a",className:"restore",target:e,onclick:e=>r({event:e,quotation:t.data,nextMethod:t.nextMethod}),innerHTML:"Kh\xf4i phục"},]}),t.restoreProduct=({event:t,quotation:e,nextMethod:a})=>{t.preventDefault();let n=t.target.target,r=document.querySelector(`#product_${n}`);r.querySelector(".overlay").remove(),["noprint","table__row"].map(t=>r.classList.toggle(t));e.products.find(t=>t.parentID==n).status="onprint",a({quotation:e})},t.nextMethod=({quotation:t})=>!1,t.createPathUpdate=({path:t,logic:e})=>(e.map((e,a)=>{let n=JSON.stringify(e);n=(n=(n=n.replace(/({)|(})|(")/g,"")).replace(/:/g,"|")).replace(/,/g,"."),t=t.replace(`{${a}}`,`.${n}`)}),t),t.createAttribute=({parentID:e,orderId:a,attributes:r})=>r.map(({label:r,name:o,slug:i})=>n({tag:"span",className:`spec__group ${i}`,innerHTML:`<b>${r}:</b> `,children:[{tag:"span",className:"editable",innerHTML:`${o}`,contentEditable:!0,data:{path:t.createPathUpdate({path:".products{0}.attributes{1}",logic:a?[{orderId:a,parentID:e},{slug:i}]:[{parentID:e},{slug:i}]}),field:"name",value:o},onfocusout:e=>t.updateDataLineEdited({target:e.target,quotation:t.data}),onkeydown:e=>t.nomalEnterToUpdate({event:e,quotation:t.data})}]})),t.createProductLine=({orderId:e,parentID:a,price:r,field:o,edit:i,methods:s})=>{let l=e?[{orderId:e,parentID:a},{productID:r.productID}]:[{parentID:a},{productID:r.productID}],d=t.createPathUpdate({path:".products{0}.prices{1}",logic:l});return n({tag:"span",className:`child ${i?"editable":"uneditable"} child__${o}`,innerHTML:-1!==["note"].indexOf(o)?`${r[o]}`:`${r[o].toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}`,contentEditable:i,data:{path:d,value:r[o],field:o},...s})},t.productName=({path:e,field:a,value:r})=>n({tag:"span",className:"bold",innerHTML:"*&nbsp;",children:[{tag:"span",className:"editable",innerHTML:r,contentEditable:!0,data:{path:e,field:a,value:r},onfocusout:e=>t.updateDataLineEdited({target:e.target,quotation:t.data}),onkeydown:e=>t.nomalEnterToUpdate({event:e,quotation:t.data})}]}),t.nomalEnterToUpdate=({event:e,quotation:a})=>{let n=e.code.toLowerCase(),r={enter(){t.updateDataLineEdited({target:e.target,quotation:a}),e.preventDefault()},numpadenter:()=>r.enter(),escape:()=>t.undoValue({target:e.target})};return r[n]?r[n]():()=>{}},t.createChildProduct=({orderId:e,parentID:a,prices:n,field:r,edit:o})=>n?n.map((n,i)=>{let s=-1===["total","note"].indexOf(r)?{onfocus:e=>t.setContentToEdit(e.target),onfocusout:e=>t.updateDataLineEdited({target:e.target,quotation:t.data,afterUpdate:[t.updateTotal,t.setContentToShow]}),onkeydown:e=>t.setEnterToUpdate({event:e,quotation:t.data,mirror:s.onfocusout})}:{onfocusout:e=>t.updateDataLineEdited({target:e.target,quotation:t.data}),onkeydown:e=>t.nomalEnterToUpdate({event:e,quotation:t.data})},l=t.createProductLine({orderId:e,parentID:a,price:n,field:r,edit:o,methods:s});return"total"==r&&0==i&&l.addEventListener("DOMSubtreeModified",e=>t.updateVATFromTotal({quotation:t.data})),l}):[],t.setContentToEdit=t=>{t.textContent=t.data.value},t.setContentToShow=({target:t})=>{t.textContent=t.data.value.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")},t.setEnterToUpdate=({event:e,quotation:a})=>{let n=e.code.toLowerCase(),r={space:()=>!1,enter(){t.updateDataLineEdited({target:e.target,quotation:t.data,afterUpdate:[t.updateTotal]}),e.preventDefault()},numpadenter:()=>r.enter(),escape:()=>t.undoValue({target:e.target}),default:()=>-1==="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ~!@#$%^&*()_-+=/,<.>/?`':\";".indexOf(e.key)};return r[n]?r[n]():r.default()},t.undoValue=({target:t})=>t.textContent=t.data.value,t.updateTotal=({target:e,quotation:a})=>{let n=t.superSearchField({target:a,path:e.data.path});return n&&(n.total=n.price*n.quantity),Array.from(document.querySelectorAll(".child__total")).find(t=>t.data.path==e.data.path).textContent=n.total.toString().replace(/\B(?=(\d{3})+(?!\d))/g,","),!1},t.updateContentEditedElement=({event:e,quotation:a})=>{let n=e.target,r=n.id,o=a.forms.find(t=>!0==t.status).modifies.find(t=>t.id==r);return o.changed=!0,o.content=n.innerHTML,t.data.saved=!1,!1},t.ctrlSToSave=({event:e,quotation:a})=>{let n=window.navigator.platform.match("Mac")?e.metaKey:e.ctrlKey,r=e.code.toLowerCase();if(n)switch(r){case"keys":e.preventDefault(),t.saveProducts({message:"Đ\xe3 lưu dữ liệu xuống localStorage!"});break;case"keyr":e.preventDefault(),t.refreshTemplate({form:t.data.forms.find(t=>!0===t.status)});break;case"keye":e.preventDefault(),t.refreshTemplateOnServer({restAPI:t.restAPI,form:t.data.forms.find(t=>!0===t.status)});break;case"keyp":e.preventDefault(),window.print()}},t.createEnablePrint=({ID:e,forProduct:a,onclickMethod:r})=>[n({tag:"a",className:"noprint__button",target:e,innerHTML:'<span class="dashicons dashicons-hidden"></span>',onclick:e=>r({event:e,quotation:t.data})}),...a?[n({tag:"a",className:"delete__button",target:e,innerHTML:'<span class="dashicons dashicons-trash"></span>',onclick:e=>t.deleteProductOutForm({event:e,quotation:t.data})})]:[],],t.deleteProductOutForm=({event:e,quotation:a})=>{e.preventDefault();let n=e.target.closest("a").target,r=a.products.find(t=>t.parentID==n);masterModal.open({options:{title:"Cảnh b\xe1o xo\xe1 sản phẩm ra khỏi b\xe1o gi\xe1",content:t.deleteProductMesage({product:r}),clear:!0,header:!0}})},t.deleteProductMesage=({product:e})=>n({tag:"p",className:"message",innerHTML:`Bạn thật sự muốn xo\xe1 sản phẩm <b>${e.productName}</b> ra khỏi b\xe1o gi\xe1&nbsp;`,children:[{tag:"a",href:"#",class:"button btn",innerHTML:"X\xe1c nhận xo\xe1",onclick:a=>t.deletedProductOutFormForever({product:e,quotation:t.data})}]}),t.deletedProductOutFormForever=({product:e,quotation:a})=>{document.querySelector(`#product_${e.parentID}`).remove(),a.products=a.products.filter(t=>t.parentID!=e.parentID),a.vat&&(a.vat.data=t.updateVAT({products:a.products}),t.pushVATToController({vat:a.vat})),masterModal.close({clear:!0})},t.noprintProduct=({event:e,quotation:a})=>{e.preventDefault();let n=e.target.closest("a").target,r=document.querySelector(`#product_${n}`),o=t.createOverlay({target:n,message:"Sản phẩm n\xe0y sẽ kh\xf4ng được in, bạn muốn",restore:t.restoreProduct});r.append(o),["noprint","table__row"].map(t=>r.classList.toggle(t));a.products.find(t=>t.parentID==n).status="noprint",a.vat&&(a.vat.data=t.updateVAT({products:a.products}),t.pushVATToController({vat:a.vat}))},t.createUnit=({unit:e,parentID:a,orderId:r,edit:o,methods:i})=>n({tag:"span",className:`child ${o?"editable":"uneditable"} child__unit`,innerHTML:e,contentEditable:o,data:{path:t.createPathUpdate({path:".products{0}",logic:r?[{orderId:r,parentID:a}]:[{parentID:a}]}),field:"unit",value:e},...i})},masterNotice=new t().init({id:"noticemaster"}),masterModal=new e().init({id:"modalmaster",options:{clear:!0,title:"Th\xf4ng b\xe1o",header:!0,footer:!1}});export{Master,masterNotice,masterModal};