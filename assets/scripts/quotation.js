import{Master as t,masterModal as e,masterNotice as r}from"./master.js";import{Accordion as a}from"./uxui/Accordion.js";import{createFormItem as o}from"./helpers/formgroup.js";import{QUOTATION_TEMPLATE_API as n}from"./helpers/const.js";import{trantlateNumbertoVNString as u}from"./helpers/numbytext.js";let Quotation=function(){let a=new t;a.storageName="quotation",a.title="Bảng b\xe1o gi\xe1";let n=a.onMainPage;return a.onMainPage=({layout:t,data:e})=>{let r=n({layout:t,data:e});return r=a.pushVATTocurrentLayout({vat:e?.vat,layout:t}),r=a.pushEnablePrintVATLayout({layout:t})},a.nextMethod=({quotation:t})=>{t.vat.data=a.updateVAT({products:t.products}),a.pushVATToController({vat:t.vat})},a.otherPage=()=>{Array.from(a.listButtons()).map(t=>{let e=JSON.parse(t.getAttribute("data"));Object.assign(t,{ownData:e,onclick:t=>a.updateQuotation(t)})}),a.setAddQuotaionButtons()},a.updateQuotation=t=>{t.preventDefault();let{type:e,...r}=t.target.ownData;return a[`updateQuotation${e}`]({...r,quotation:a.data})},a.updateQuotationProduct=({ID:t,parentID:r,quotation:o})=>{let n=0!==r?a.checkExistProductVariation({quotation:o,ID:t}):a.checkExistProductVariable({quotation:o,ID:t});n?e.open({options:{title:"Cảnh b\xe1o đ\xe3 c\xf3 sản phẩm trong b\xe1o gi\xe1",content:a.updateProductVariableForm({product:n,ID:t,parentID:r,quotation:o})}}):a.updateProductInQuotation({ID:t,parentID:r,quotation:o,update:!1})},a.updateProductInQuotation=async({ID:t,parentID:o,quotation:n,update:u})=>{try{let i=await a.getProduct({ID:t}),s=0!==o?o:t,c=n.products?n.products.find(t=>t.parentID==s):void 0;if(u){let p=n.products.findIndex(t=>t.parentID==c.parentID);if(0==o)n.products[p]=i;else{let d=n.products[p].prices.findIndex(t=>t.productID==i.prices[0].productID);n.products[p].prices[d]=i.prices[0]}}else 0!=o&&c?c.prices=[...c.prices,...i.prices]:n.products=n.products?[...n.products,i]:[i];let l=a.updateVAT({products:n.products});n.vat=n.vat?{...n.vat,data:l}:{data:l,status:!0},localStorage.setItem(a.storageName,JSON.stringify(n)),e.close({clear:!0}),r.open({message:`Đ\xe3 ${!0===u?"Cập nhật":"th\xeam mới"} sản phẩm v\xe0o b\xe1o gi\xe1`,icon:!0,style:"info",timer:1500})}catch{}},a.updateQuotationUser=async({ID:t,quotation:e})=>{try{let o=await a.getUser({user:t});e.user=o.user,localStorage.setItem(a.storageName,JSON.stringify(e))}catch{}finally{r.open({message:"Đ\xe3 th\xeam người d\xf9ng v\xe0o b\xe1o gi\xe1",icon:!0,style:"info",timer:1500})}},a.updateQuotationOrder=async({ID:t,quotation:e})=>{try{let o=await a.getOrder({orderId:t}),n={...e,...o};n.vat={data:a.updateVAT({products:n.products}),status:!0},localStorage.setItem(a.storageName,JSON.stringify(n)),r.open({message:`Đ\xe3 tạo lại b\xe1o gi\xe1 của đơn h\xe0ng #${t}`,icon:!0,style:"info",timer:1500})}catch{}},a.pushVATTocurrentLayout=({vat:t,layout:e})=>{if(!t)return e;t.data&&t.data.forEach(({vatName:t,vatValue:r})=>e.querySelector(`.${t}`).innerHTML=r.toString().replace(/\B(?=(\d{3})+(?!\d))/g,","));let r=e.querySelector(".products__vat");return!1===(t?.status??!1)&&(r=a.markNoprintVAT({vatRow:r,target:"products__vat"})),e},a.pushEnablePrintVATLayout=({layout:t})=>{if(!t)return t;let e=t.querySelector(".products__vat .enableprint"),r=a.createEnablePrint({ID:"products__vat",forProduct:!1,onclickMethod:a.noprintVAT});return e.append(...r),t},a.markNoprintVAT=({vatRow:t,target:e})=>{t.classList.add("noprint");let r=a.createOverlay({target:e,message:"D\xf2ng th\xe0nh tiền, kh\xf4ng được in. Bạn muốn ",restore:a.restoreVAT});return t.append(r),t},a.noprintVAT=({event:t,quotation:e})=>{let r=t.target.closest("a").target;e&&e.vat?e.vat.status=!1:e.vat={status:!1};let o=document.querySelector(`.${r}`);o=a.markNoprintVAT({vatRow:o,target:r}),localStorage.setItem(a.storageName,JSON.stringify(e))},a.restoreVAT=({event:t,quotation:e})=>{let r=t.target.closest("a").target;e.vat.status=!0;let o=document.querySelector(`.${r}`);o.classList.remove("noprint"),o.querySelector(".overlay").remove(),localStorage.setItem(a.storageName,JSON.stringify(e))},a.createSpecificationsProduct=({parentID:t,productName:e,attributes:r})=>[a.productName({productName:e,data:{ID:t,field:"productName"}}),...r?a.createAttribute({parentID:t,attributes:r}):[]],a.listButtons=()=>document.querySelectorAll(".updateQuotation"),a.setAddQuotaionButtons=()=>{let t=document.querySelector("#variable_product_options");t&&(t.onchange=t=>a.varProductOptionChange(t))},a.varProductOptionChange=t=>{Array.from(a.listButtons()).map(t=>{let e=JSON.parse(t.getAttribute("data"));Object.assign(t,{ownData:e,onclick:t=>a.updateQuotation(t)})})},a.quotationOder=async t=>{t.preventDefault();let e=JSON.parse(t.target.getAttribute("data")).productID;try{let r=await a.getOrder({orderId:e});r.user=a.filterCustomerFields(r.user)}catch{}},a.checkExistProductVariable=({quotation:t,ID:e})=>t?.products&&t?.products.find(t=>t.parentID==e),a.updateProductVariableForm=({product:t,ID:e,parentID:r,quotation:n})=>o({tag:"p",className:"Message",innerHTML:`Sản phẩm <b> ${t.productName}</b> bạn muốn th\xeam v\xe0o b\xe1o gi\xe1 đ\xe3 tồn tại! bạn c\xf3 muốn cập nhật mới kh\xf4ng?&nbsp;`,children:[{tag:"a",href:"#",class:"button btn",innerHTML:"Cập nhật mới",onclick:t=>(t.preventDefault(),a.updateProductInQuotation({ID:e,parentID:r,quotation:n,update:!0}))}]}),a.checkExistProductVariation=({quotation:t,ID:e})=>t?.products&&t?.products.find(t=>t?.prices.find(t=>t.productID==e)),a.updateProductVariation=async({productID:t,quotation:e})=>{try{let o=await a.getProduct({productID:t}),n=e.products.find(t=>t.parentID==o.product.parentID).prices;n[n.findIndex(e=>e.productID==t)]=o.product.prices[0],r.open({message:"Đ\xe3 th\xeam sản phẩm v\xe0o b\xe1o gi\xe1",icon:!0,style:"info",timer:1500})}catch{}},a.updateVAT=({products:t})=>{let e=t.map(t=>"onprint"==t.status?t.prices[0].total:0).reduce((t,e)=>t+e,0),r=[];return 0!=(r=u(r,Math.round(1.1*e),0)).length&&(r[0]=r[0].replace(",","")),[{vatName:"totalBeforeVAT",vatValue:e},{vatName:"vatPercentage",vatValue:Math.round(.1*e)},{vatName:"totalpaid",vatValue:Math.round(1.1*e)},{vatName:"byWord",vatValue:`${r.reverse().join(" ")} đồng`},]},a.updateVATFromTotal=({quotation:t})=>{t.vat.data=a.updateVAT({products:t.products}),a.pushVATToController({vat:t.vat})},a.pushVATToController=({vat:t})=>{t&&t.data.forEach(({vatName:t,vatValue:e})=>document.querySelector(`.${t}`).innerHTML=e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,","))},a},quotation=new Quotation().init({id:"sheetQuotation",templateName:"templateone",restAPI:n});window.onload=function(){new a().init({id:"accordion",onlyAccordionOpen:!0})};