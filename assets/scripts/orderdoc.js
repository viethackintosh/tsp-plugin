import{fchRequest as e}from"./helpers/fetch.js";import{createFormItem as t}from"./helpers/formgroup.js";import{masterModal as o,masterNotice as r}from"./master.js";import{URI_UPLOAD as n}from"./helpers/const.js";import{DragDrop as a}from"./uxui/Dragdrop.js";let DDocument=function(){let l=this;l.fileContent,l.form,l.init=()=>(Array.from(document.querySelectorAll(".order--document")).map(e=>{let t=JSON.parse(e.getAttribute("data"));e.removeAttribute("data"),Object.assign(e,{owner:t});let o=e.querySelector(".delete__button");o&&Object.assign(o,{onclick:e=>l.removeDocument({event:e})});let r=e.querySelector(".preview--document");r&&(r.onclick=e=>l.previewDocument({event:e}));let n=e.querySelector(".upload--document");n&&(n.onclick=e=>l.uploadDocument({event:e}))}),l.reader=new FileReader,l.reader.addEventListener("load",e=>{l.fileContent=e.target.result}),l.form=l.dragAndDropUploadForm(),l),l.removeButton=()=>t({tag:"span",className:"dashicons dashicons-no-alt delete__button",onclick:e=>l.removeDocument({event:e})}),l.removeDocument=async({event:t})=>{t.preventDefault();let o=t.target.closest("a"),n=o.owner;n.file="";let a=o.querySelector(".preview--document");a.innerHTML=n.title,a.classList.remove("preview--document"),a.classList.add("upload--document"),a.onclick=e=>l.uploadDocument({event:e}),o.querySelector(".delete__button").remove();try{let i=await e({ftchURI:"/wp-json/tinsinhphuc/document/remove",data:{method:"POST",body:JSON.stringify({owner:n})}});r.open({message:i.message,icon:!0,style:"info",timer:1500})}catch{}},l.previewDocument=({event:e})=>{e.preventDefault();let t=e.target.closest("a").owner;PDFObject.embed(`${n}${t.file}`,"#modalmaster .modal__body",{height:"830px",width:"830px"}),o.open({config:{clear:!0,title:`Bạn đang xem ${t.file}`,header:!0,footer:!1}})},l.uploadDocument=({event:e})=>{e.preventDefault();let t=e.target.closest("a"),r=o.modal.body.querySelector("#uploader"),n=o.modal.footer.querySelector(".upload__toserver");r||o.modal.body.append(l.form.drag.main),n?n.target=t:o.modal.footer.append(l.uploadButtonFiles({target:t})),o.open({config:{title:`Bạn ${t.owner.title} cho #${t.owner.ID}`,footer:!0}})},l.dragAndDropUploadForm=()=>{let e=new a().init({id:"uploader",config:{label:"Ấn hoặc k\xe9o thả file v\xe0o đ\xe2y",dataType:"file",multiple:!1,accept:"application/pdf"}});return e},l.choiceFileChange=({event:e})=>{let t=e.target.files[0],o=e.target.files[0].name,r=document.querySelector(".upload__filename");r&&(r.innerHTML=o),l.reader.readAsDataURL(t)},l.uploadButtonFiles=({target:e})=>t({tag:"p",className:"upload__server",children:[{tag:"span",innerHTML:"Tải l\xean server",className:"upload__toserver button --primary",target:e,onclick:e=>l.uploadFileToServer({event:e})}]}),l.uploadFileToServer=async({event:t})=>{let n=l.form.drag.input.files[0],a=t.target.target,i=new FormData;if(i.append("files",n),i.append("owner",JSON.stringify(a.owner)),n)try{let s=await e({ftchURI:"/wp-json/tinsinhphuc/document/upload",data:{method:"POST",body:i,headers:{}}});if(s.result){a.owner.file=n.name;let c=a.querySelector(".upload--document");c.innerHTML=n.name,c.classList.remove("upload--document"),c.classList.add("preview--document"),c.onclick=e=>l.previewDocument({event:e}),a.append(l.removeButton()),l.form.drag.input.value=null,l.form.drag.result.innerHTML="",o.close(),r.open({message:s.message,icon:!0,style:"info",timer:1500})}else l.form.message.innerHTML=s.message}catch{}else l.form.message.innerHTML="Chọn file đi \xd4ng thần ve chai!!!!"}},dDocument=new DDocument().init();