import{fchRequest as e}from"./helpers/fetch.js";import{createFormItem as t}from"./helpers/formgroup.js";import{masterModal as o,masterNotice as r}from"./master.js";import{URI_UPLOAD as a}from"./helpers/const.js";import{DragDrop as n}from"./uxui/Dragdrop.js";let DDocument=function(){let l=this;l.fileContent,l.reader,l.form,l.init=()=>(Array.from(document.querySelectorAll(".order--document")).map(e=>{let t=JSON.parse(e.getAttribute("data"));e.removeAttribute("data"),Object.assign(e,{owner:t});let o=e.querySelector(".delete__button");o&&Object.assign(o,{onclick:e=>l.removeDocument({event:e})});let r=e.querySelector(".preview--document");r&&(r.onclick=e=>l.previewDocument({event:e}));let a=e.querySelector(".upload--document");a&&(a.onclick=e=>l.uploadDocument({event:e}))}),l.reader=new FileReader,l.reader.addEventListener("load",e=>{l.fileContent=e.target.result}),l.form=l.dragAndDropUploadForm(),l),l.removeButton=()=>t({tag:"span",className:"dashicons dashicons-trash delete__button",onclick:e=>l.removeDocument({event:e})}),l.removeDocument=async({event:t})=>{t.preventDefault();let o=t.target.closest("a"),a=o.owner;a.file="";let n=o.querySelector(".preview--document");n.innerHTML=a.title,n.classList.remove("preview--document"),n.classList.add("upload--document"),n.onclick=e=>l.uploadDocument({event:e}),o.querySelector(".delete__button").remove();try{let i=await e({ftchURI:"/wp-json/tinsinhphuc/document/remove",data:{method:"POST",body:JSON.stringify({owner:a})}});r.open({message:i.message,icon:!0,style:"info",timer:1500})}catch{}},l.previewDocument=({event:e})=>{e.preventDefault();let t=e.target.closest("a").owner;PDFObject.embed(`${a}${t.file}`,"#modalmaster .modal__body",{height:"830px",width:"830px"}),o.open({options:{clear:!0,title:`Bạn đang xem ${t.file}`,header:!0,footer:!1}})},l.uploadDocument=({event:e})=>{e.preventDefault();let t=e.target.closest("a"),r=o.modal.body.querySelector("#uploader"),a=o.modal.footer.querySelector(".upload__toserver");r||o.modal.body.append(l.form.drag.main),a?a.target=t:o.modal.footer.append(l.uploadButtonFiles({target:t})),o.open({options:{title:`Bạn ${t.owner.title} cho #${t.owner.ID}`,footer:!0}})},l.dragAndDropUploadForm=()=>{let e=new n().init({id:"uploader",config:{message:"K\xe9o thả file v\xe0o đ\xe2y để tải l\xean",label:"Ấn v\xe0o đ\xe2y để chọn file",multiple:!0,accept:"application/pdf"}});return e},l.uploadDocumentForm=()=>{let e=t({tag:"p",className:"upload__message"}),o=t({tag:"span",innerHTML:"file name here",className:"upload__filename"}),r=t({tag:"input",type:"file",accept:".pdf",id:"filetoupload",style:"display:none",onchange:e=>l.choiceFileChange({event:e})});return{form:t({tag:"div",className:"upload__wrapper",children:[e,t({tag:"p",className:"upload__item",children:[o,]}),t({tag:"label",className:"upload__choicefile button --primary",innerHTML:"Chọn file",children:[r,]}),]}),message:e,uploadFileName:o,inputFile:r}},l.choiceFileChange=({event:e})=>{let t=e.target.files[0],o=e.target.files[0].name,r=document.querySelector(".upload__filename");r&&(r.innerHTML=o),l.reader.readAsDataURL(t)},l.uploadButtonFiles=({target:e})=>t({tag:"p",className:"upload__server",children:[{tag:"span",innerHTML:"Tải l\xean server",className:"upload__toserver button --primary",target:e,onclick:e=>l.uploadFileToServer({event:e})}]}),l.uploadFileToServer=async({event:t})=>{let a=l.form.inputFile.files[0],n=t.target.target;if(a){let i={name:a.name,type:a.type,fileContent:l.fileContent};try{let s=await e({ftchURI:"/wp-json/tinsinhphuc/document/upload",data:{method:"POST",body:JSON.stringify({owner:n.owner,file:i})}});if(s.result){n.owner.file=a.name;let m=n.querySelector(".upload--document");m.innerHTML=a.name,m.classList.remove("upload--document"),m.classList.add("preview--document"),m.onclick=e=>l.previewDocument({event:e}),n.append(l.removeButton()),l.form.inputFile.value=null,l.form.uploadFileName.innerHTML="File name here",l.form.message.innerHTML="",o.close({clear:!1}),r.open({message:s.message,icon:!0,style:"info",timer:1500})}else l.form.message.innerHTML=s.message}catch{}}else l.form.message.innerHTML="Chọn file đi \xd4ng thần ve chai!!!!"}},dDocument=new DDocument().init();